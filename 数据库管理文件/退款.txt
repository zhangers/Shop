#include <stdio.h>
#include "mysql.h"
#include<iostream>
using namespace std;
void main()
{
    char sql[150]; // sql语句
    MYSQL mysql; //一个数据库结构体
    MYSQL_RES* res; //一个结果集结构体
    MYSQL_ROW row; //char** 二维数组，存放一条条记录
    //初始化数据库
    mysql_init(&mysql);
    //设置编码方式
    mysql_options(&mysql, MYSQL_SET_CHARSET_NAME, "gbk");
    //连接数据库
    //判断如果连接失败就把连接失败的信息显示出来，我们好进行对应修改。
    // mysql_real_connect参数：2.本地地址 3.你的mysql用户名 4.你的mysql密码 5.数据库名字 6.端口号
    if (mysql_real_connect(&mysql, "localhost", "root", "1234", "membership", 3306, NULL, 0) == NULL) {
        cout << (mysql_error(&mysql));
    }


    //查询数据
    mysql_query(&mysql, "SELECT * from purchasehistory");
    //获取结果集
    res = mysql_store_result(&mysql);
    //显示数据
 //给ROW赋值，判断ROW是否为空，不为空就打印数据。
    cout << "会员号         商品号          购买数量" << endl;
    while (row = mysql_fetch_row(res))
    {
        printf("%s ", row[0]);//打印会员
        cout << "            ";
        printf("%s ", row[1]);//打印会员号
        cout << "            ";
        printf("%s ", row[2]);//打印会员号

        cout << endl;
    }
    //释放结果集
    mysql_free_result(res);



    cout << "退款" << endl;
    cout << "请输入会员号" << endl;
    string ID;
    cin >> ID;
    cout << endl;
    cout << "请输入商品号" << endl;
    string PASS;
    cin >> PASS;
    cout << "请输入购买数量" << endl;
    string NUM;
    cin >> NUM;
    //查询数据
    mysql_query(&mysql, "SELECT * from purchasehistory");
    //获取结果集
    res = mysql_store_result(&mysql);
    //显示数据
    //给ROW赋值，判断ROW是否为空，不为空就打印数据。
    while (row = mysql_fetch_row(res))
    {
        string i;
        string p;
        string n;
        i = row[0];

        p = row[1];
        n = row[2];

        if (ID == i)
        {

            if (PASS == p)
            {
                if (NUM == n)
                {
                    //删除数据
                    string sql_insert = "delete  from purchasehistory where 会员号=" + ID + " AND 购买数量=" + NUM + " AND 购买过的货物好=" + PASS + "";
                    //cout << sql_insert << endl;
                    if (!mysql_query(&mysql, sql_insert.c_str())) // 执行SQL语句
                    {
                        cout << "退款成功" << mysql_error(&mysql) << endl;

                    }
                    else
                    {
                        cout << "退款失败..." << endl;

                    }
                }

            }
        }
        cout << endl;
    }


    //释放结果集
    mysql_free_result(res);
    //关闭数据库
    mysql_close(&mysql);
    //停留等待
    getchar();
    cout << "账户或密码错误，登录失败";
}